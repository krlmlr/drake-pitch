---
title: "Reproducible workflows with the [drake](https://github.com/ropensci/drake) R package"
subtitle: "make for R"
author: "Kirill MÃ¼ller"
date: "`r Sys.Date()`, DataCamp audition video"
output:
  xaringan::moon_reader:
    output_dir: "docs"
    lib_dir: docs/libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
options(width = 65)
knit_print.data.frame <- function(x, ...) paste0(format(as_tibble(x)), collapse = "\n")
knitr::opts_chunk$set(collapse = TRUE)
knitr::opts_chunk$set(fig.path = "index_files/figure-html/")

pkgconfig::set_config_in("drake::strings_in_dots" = "literals", .in = globalenv())
```

background-image: url(images/humane.png)
class: inverse

???

From Jenny's presentation: https://github.com/jennybc/what-they-forgot

---

```{r library, include = FALSE}
library(drake)
library(tidyverse)
unlink(".drake", recursive = TRUE)
```

```{r plan}
library(drake)
library(tidyverse)
plan <- drake_plan(
  
  raw_data = readxl::read_xlsx(file_in("raw-data.xlsx")),

  data = raw_data %>%
    mutate(Species = forcats::fct_inorder(Species)),
  
  hist = ggplot(data, aes(x = Petal.Width, fill = Species)) +
    geom_histogram(),
  
  model = lm(Sepal.Width ~ Petal.Width + Species, data)
  
)

plan
```

---

```{r vis-new, echo = FALSE}
config <- drake_config(plan, verbose = FALSE)
vis_drake_graph(
  config,
  from = file_store("raw-data.xlsx"), mode = "out",
  build_times = "none", full_legend = FALSE,
  width = "100%"
)
```

---

```{r make}
make(plan)
```

---

```{r make-again}
make(plan)
```

---

```{r vis-done, echo = FALSE}
config <- drake_config(plan, verbose = FALSE)
vis_drake_graph(
  config,
  from = file_store("raw-data.xlsx"), mode = "out",
  build_times = "none", full_legend = FALSE,
  width = "100%"
)
```


---

```{r data}
loadd(data)
data
```

---

```{r hist, fig.height = 3}
loadd(hist, verbose = 0)
hist
```

---

```{r model}
summary(readd(model))
```

---

```{r better-plan}
plan <- drake_plan(
  
  raw_data = readxl::read_xlsx(file_in("raw-data.xlsx")),
  
  data = raw_data %>%
    mutate(Species = forcats::fct_inorder(Species)) %>% 
    select(-X__1), #<<
  
  hist = ggplot(data, aes(x = Petal.Width, fill = Species)) +
    geom_histogram(bins = 10), #<<
  
  model = lm(Sepal.Width ~ Petal.Width + Species, data)
  
)
```

---

```{r vis-stale, echo = FALSE}
config <- drake_config(plan, verbose = FALSE)
vis_drake_graph(
  config,
  from = file_store("raw-data.xlsx"), mode = "out",
  build_times = "none", full_legend = FALSE,
  width = "100%"
)
```

---

```{r make-fixed, fig.height = 3}
make(plan)
readd(hist)
names(readd(data))
```

---

```{r vis-full, echo = FALSE}
config <- drake_config(plan, verbose = FALSE)
vis_drake_graph(
  config,
  build_times = "none", full_legend = FALSE,
  width = "100%"
)
```
