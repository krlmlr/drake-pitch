---
title: "Reproducible workflows with the [drake](https://github.com/ropensci/drake) R package"
subtitle: "make for R"
author: "Kirill MÃ¼ller"
date: "`r Sys.Date()`, DataCamp audition video"
output:
  xaringan::moon_reader:
    output_dir: "docs"
    lib_dir: docs/libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
options(width = 65)
knit_print.data.frame <- function(x, ...) paste0(format(as_tibble(x)), collapse = "\n")
knitr::opts_chunk$set(collapse = TRUE)
knitr::opts_chunk$set(fig.path = "index_files/figure-html/")

pkgconfig::set_config_in("drake::strings_in_dots" = "literals", .in = globalenv())
```

background-image: url(images/humane.png)
class: inverse

???

From Jenny's presentation: https://github.com/jennybc/what-they-forgot

---

```{r cleanup, include = FALSE}
unlink(".drake", recursive = TRUE)
```

```{r plan-base-vis, include = FALSE}
library(drake)
library(tidyverse)
create_plot <- function(data) {
  ggplot(data, aes(x = Petal.Width, fill = Species)) +
    geom_histogram()
}

plan <- drake_plan(
  raw_data = readxl::read_xlsx(file_in("raw-data.xlsx")),

  data = mutate(raw_data, Species = forcats::fct_inorder(Species)),
  
  hist = create_plot(data),
  
  fit = lm(Sepal.Width ~ Petal.Width + Species, data)
)
```

```{r vis-intro, echo = FALSE}
config <- drake_config(plan, verbose = FALSE)
vis_drake_graph(
  config,
  from = file_store("raw-data.xlsx"), mode = "out",
  build_times = "none", ncol_legend = 0,
  width = "100%"
)
```


---

```{r plan-base}
library(drake)
library(tidyverse)

create_plot <- function(data) {
  ggplot(data, aes(x = Petal.Width, fill = Species)) +
    geom_histogram()
}

plan <- drake_plan(
  raw_data = readxl::read_xlsx(file_in("raw-data.xlsx")),

  data = raw_data %>%
    mutate(Species = forcats::fct_inorder(Species)),
  
  hist = create_plot(data),
  
  fit = lm(Sepal.Width ~ Petal.Width + Species, data)
)

plan
```

---

```{r make}
make(plan)
summary(readd(fit))
```

---

```{r data}
loadd(data, hist)
data
```

---

```{r better-plan}
create_plot <- function(data) {
  ggplot(data, aes(x = Petal.Width, fill = Species)) +
    geom_histogram()
}

plan <- drake_plan(
  raw_data = readxl::read_xlsx(file_in("raw-data.xlsx")),

  data = raw_data %>% 
    mutate(Species = forcats::fct_inorder(Species)) %>%
    select(-X__1), #<<
  
  hist = create_plot(data),
  
  fit = lm(Sepal.Width ~ Petal.Width + Species, data)
)
```

---

```{r vis-stale, echo = FALSE}
config <- drake_config(plan, verbose = FALSE)
vis_drake_graph(
  config,
  from = file_store("raw-data.xlsx"), mode = "out",
  build_times = "none", full_legend = FALSE,
  width = "100%"
)
```

---

```{r make-fixed}
make(plan)
readd(data)
```

---

```{r show-hist}
readd(hist)
```

---

```{r best-plan}
create_plot <- function(data) {
  ggplot(data, aes(x = Petal.Width, fill = Species)) +
    geom_histogram(binwidth = 0.25) + #<<
    theme_bw(20) #<<
}

plan <- drake_plan(
  raw_data = readxl::read_xlsx(file_in("raw-data.xlsx")),

  data = raw_data %>% 
    mutate(Species = forcats::fct_inorder(Species)) %>%
    select(-X__1),
  
  hist = create_plot(data),
  
  fit = lm(Sepal.Width ~ Petal.Width + Species, data)
)
```

---

```{r cleanup-env, include = FALSE}
rm(fit, hist, data)
```


```{r make-fixed-hist}
make(plan)
readd(hist)
```

---

```{r vis-full, echo = FALSE}
config <- drake_config(plan, verbose = FALSE)
vis_drake_graph(
  config,
  build_times = "none", full_legend = FALSE,
  width = "100%"
)
```

---

class: inverse, middle, center
